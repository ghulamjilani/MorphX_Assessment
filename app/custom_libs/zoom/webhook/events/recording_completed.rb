# frozen_string_literal: true

# {
#   "payload" => {
#     "account_id" => "zI8tjMxnTHmSj0vLMQ1_wA",
#     "object" => {
#       "uuid" => "EnHa3FlBSWCo5yOup69pOw==",
#       "id" => 9206225653,
#       "account_id" => "zI8tjMxnTHmSj0vLMQ1_wA",
#       "host_id" => "OdT9FmVRSg6epnzDHUm2vw",
#       "topic" => "Daryna Varankover's Personal Meeting Room",
#       "type" => 4,
#       "start_time" => "2021-02-01T16:16:00Z",
#       "timezone" => "Europe/Kiev",
#       "host_email" => "stdashulya@gmail.com",
#       "duration" => 4,
#       "total_size" => 9403523,
#       "recording_count" => 6,
#       "share_url" => "https://us02web.zoom.us/rec/share/g6BkGJZvE-zna2HgZOG0YoQwMgMDeykv5RjbpuaeHeqACiCO0xcY6FhGiYGxczt4.94WwcE568I1gA6M7",
#       "recording_files" => [{
#                               "id" => "8649a87a-2261-42da-b787-09c379844ae4",
#                               "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                               "recording_start" => "2021-02-01T16:20:20Z",
#                               "recording_end" => "2021-02-01T16:22:18Z",
#                               "file_type" => "MP4",
#                               "file_extension" => "MP4",
#                               "file_size" => 2189255,
#                               "play_url" => "https://us02web.zoom.us/rec/play/e0DYucW3MfTTGlUBrswnnzq5EaFdjauisKHHQ__kjhXRFRLxp2DKEUSPn14GM00r0PWjiCZSog-3k_bc.hAHgeOA6cj_c9c4t",
#                               "download_url" => "https://us02web.zoom.us/rec/webhook_download/e0DYucW3MfTTGlUBrswnnzq5EaFdjauisKHHQ__kjhXRFRLxp2DKEUSPn14GM00r0PWjiCZSog-3k_bc.hAHgeOA6cj_c9c4t/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o5tyDF52jUJIn7WgWL6wXrVmPM",
#                               "status" => "completed",
#                               "recording_type" => "shared_screen_with_speaker_view" }, {
#                               "id" => "bd78b07b-993c-4c1e-aebe-9df310c6760e",
#                               "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                               "recording_start" => "2021-02-01T16:20:20Z",
#                               "recording_end" => "2021-02-01T16:22:18Z",
#                               "file_type" => "M4A",
#                               "file_extension" => "M4A",
#                               "file_size" => 1868163,
#                               "play_url" => "https://us02web.zoom.us/rec/play/StMmKzV09s3g_aFo_CK-D1paf1qtVLa1N6f1fTH41p5i9b7XgQ_o36MOCBy9Y89qzhgXqc8qqUsz6S7p.mO7zvKqlXU7PskEJ",
#                               "download_url" => "https://us02web.zoom.us/rec/webhook_download/StMmKzV09s3g_aFo_CK-D1paf1qtVLa1N6f1fTH41p5i9b7XgQ_o36MOCBy9Y89qzhgXqc8qqUsz6S7p.mO7zvKqlXU7PskEJ/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o4Jve5yERDOn8Ip7x14EORAnbQ",
#                               "status" => "completed",
#                               "recording_type" => "audio_only" }, {
#                               "id" => "d49ef40a-46df-4b52-99a9-b2e74f9e3484",
#                               "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                               "recording_start" => "2021-02-01T16:18:47Z",
#                               "recording_end" => "2021-02-01T16:20:16Z",
#                               "file_type" => "MP4",
#                               "file_extension" => "MP4",
#                               "file_size" => 1670466,
#                               "play_url" => "https://us02web.zoom.us/rec/play/MbtVkvFGf9YxIKdX9UeY5IiBGtO84K01xpduNBSpHUtGbHruFxTVHQy5qITQgxU0HaSSarHKo9uSj6ag.rTzusi_JTGKVBMiX",
#                               "download_url" => "https://us02web.zoom.us/rec/webhook_download/MbtVkvFGf9YxIKdX9UeY5IiBGtO84K01xpduNBSpHUtGbHruFxTVHQy5qITQgxU0HaSSarHKo9uSj6ag.rTzusi_JTGKVBMiX/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o5tyDF52jUJIn7WgWL6wXrVmPM",
#                               "status" => "completed",
#                               "recording_type" => "shared_screen_with_speaker_view" }, {
#                               "id" => "f8918192-09de-4fc8-ad4f-66e02fb3cec7",
#                               "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                               "recording_start" => "2021-02-01T16:18:47Z",
#                               "recording_end" => "2021-02-01T16:20:16Z",
#                               "file_type" => "M4A",
#                               "file_extension" => "M4A",
#                               "file_size" => 1412455,
#                               "play_url" => "https://us02web.zoom.us/rec/play/Zt_wyyxmwI027AXKEDw5gwF2bKq2H3nWNOvVHvUHz2CrJYBhYMc2ZzGXcrLCfJNlxiPABSC6DX6nxSda.-KhpRxdF-ojlOd-c",
#                               "download_url" => "https://us02web.zoom.us/rec/webhook_download/Zt_wyyxmwI027AXKEDw5gwF2bKq2H3nWNOvVHvUHz2CrJYBhYMc2ZzGXcrLCfJNlxiPABSC6DX6nxSda.-KhpRxdF-ojlOd-c/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o4Jve5yERDOn8Ip7x14EORAnbQ",
#                               "status" => "completed",
#                               "recording_type" => "audio_only" }, {
#                               "id" => "ef828f08-4689-436c-a05d-45d54e7b3a52",
#                               "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                               "recording_start" => "2021-02-01T16:22:25Z",
#                               "recording_end" => "2021-02-01T16:23:57Z",
#                               "file_type" => "MP4",
#                               "file_extension" => "MP4",
#                               "file_size" => 1218474,
#                               "play_url" => "https://us02web.zoom.us/rec/play/Z_JCv34Nh-yQUWWb67_cFiqENbTeSrErD8cpG5OAnm1CLO3K5XZYZ09FZC2Lo871v7qUPrgq-pAzrebt.QH3Vjprau3v7Ra0L",
#                               "download_url" => "https://us02web.zoom.us/rec/webhook_download/Z_JCv34Nh-yQUWWb67_cFiqENbTeSrErD8cpG5OAnm1CLO3K5XZYZ09FZC2Lo871v7qUPrgq-pAzrebt.QH3Vjprau3v7Ra0L/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o5tyDF52jUJIn7WgWL6wXrVmPM",
#                               "status" => "completed",
#                               "recording_type" => "shared_screen_with_speaker_view" }, {
#                               "id" => "c1fee964-195c-42f2-ab05-aeaf3a92ee5f",
#                               "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                               "recording_start" => "2021-02-01T16:22:25Z",
#                               "recording_end" => "2021-02-01T16:23:57Z",
#                               "file_type" => "M4A",
#                               "file_extension" => "M4A",
#                               "file_size" => 1044710,
#                               "play_url" => "https://us02web.zoom.us/rec/play/p5zBc5ck2qh0DzbUlcSgx7RPYMtEfac7RjKtz9M0lQ73Hl4tsCRurUJnUvESfsQYM8I3TX53fezj6NOu.ldpbXv9VIUcJqaJ5",
#                               "download_url" => "https://us02web.zoom.us/rec/webhook_download/p5zBc5ck2qh0DzbUlcSgx7RPYMtEfac7RjKtz9M0lQ73Hl4tsCRurUJnUvESfsQYM8I3TX53fezj6NOu.ldpbXv9VIUcJqaJ5/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o4Jve5yERDOn8Ip7x14EORAnbQ",
#                               "status" => "completed",
#                               "recording_type" => "audio_only" }],
#       "password" => "%0Nye8^#" } },
#   "event_ts" => 1612197156252,
#   "event" => "recording.completed",
#   "download_token" => "eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJodHRwczovL2V2ZW50Lnpvb20udXMiLCJhY2NvdW50SWQiOiJ6STh0ak14blRIbVNqMHZMTVExX3dBIiwiYXVkIjoiaHR0cHM6Ly9vYXV0aC56b29tLnVzIiwibWlkIjoiRW5IYTNGbEJTV0NvNXlPdXA2OXBPdz09IiwiZXhwIjoxNjEyMjgzODIwLCJ1c2VySWQiOiJPZFQ5Rm1WUlNnNmVwbnpESFVtMnZ3In0.z__ZLHhMp_Rav3zGcubWK94z_lJx44jgOT1hQ3xpl30BVlprMSKo4f1HayLRWa2hY3uxaYyn9Zbm5Y1RnrPQow",
#   "controller" => "webhook/v1/zoom",
#   "action" => "create",
#   "zoom" => {
#     "payload" => {
#       "account_id" => "zI8tjMxnTHmSj0vLMQ1_wA",
#       "object" => {
#         "uuid" => "EnHa3FlBSWCo5yOup69pOw==",
#         "id" => 9206225653,
#         "account_id" => "zI8tjMxnTHmSj0vLMQ1_wA",
#         "host_id" => "OdT9FmVRSg6epnzDHUm2vw",
#         "topic" => "Daryna Varankover's Personal Meeting Room",
#         "type" => 4,
#         "start_time" => "2021-02-01T16:16:00Z",
#         "timezone" => "Europe/Kiev",
#         "host_email" => "stdashulya@gmail.com",
#         "duration" => 4,
#         "total_size" => 9403523,
#         "recording_count" => 6,
#         "share_url" => "https://us02web.zoom.us/rec/share/g6BkGJZvE-zna2HgZOG0YoQwMgMDeykv5RjbpuaeHeqACiCO0xcY6FhGiYGxczt4.94WwcE568I1gA6M7",
#         "recording_files" => [{
#                                 "id" => "8649a87a-2261-42da-b787-09c379844ae4",
#                                 "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                                 "recording_start" => "2021-02-01T16:20:20Z",
#                                 "recording_end" => "2021-02-01T16:22:18Z",
#                                 "file_type" => "MP4",
#                                 "file_extension" => "MP4",
#                                 "file_size" => 2189255,
#                                 "play_url" => "https://us02web.zoom.us/rec/play/e0DYucW3MfTTGlUBrswnnzq5EaFdjauisKHHQ__kjhXRFRLxp2DKEUSPn14GM00r0PWjiCZSog-3k_bc.hAHgeOA6cj_c9c4t",
#                                 "download_url" => "https://us02web.zoom.us/rec/webhook_download/e0DYucW3MfTTGlUBrswnnzq5EaFdjauisKHHQ__kjhXRFRLxp2DKEUSPn14GM00r0PWjiCZSog-3k_bc.hAHgeOA6cj_c9c4t/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o5tyDF52jUJIn7WgWL6wXrVmPM",
#                                 "status" => "completed",
#                                 "recording_type" => "shared_screen_with_speaker_view" }, {
#                                 "id" => "bd78b07b-993c-4c1e-aebe-9df310c6760e",
#                                 "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                                 "recording_start" => "2021-02-01T16:20:20Z",
#                                 "recording_end" => "2021-02-01T16:22:18Z",
#                                 "file_type" => "M4A",
#                                 "file_extension" => "M4A",
#                                 "file_size" => 1868163,
#                                 "play_url" => "https://us02web.zoom.us/rec/play/StMmKzV09s3g_aFo_CK-D1paf1qtVLa1N6f1fTH41p5i9b7XgQ_o36MOCBy9Y89qzhgXqc8qqUsz6S7p.mO7zvKqlXU7PskEJ",
#                                 "download_url" => "https://us02web.zoom.us/rec/webhook_download/StMmKzV09s3g_aFo_CK-D1paf1qtVLa1N6f1fTH41p5i9b7XgQ_o36MOCBy9Y89qzhgXqc8qqUsz6S7p.mO7zvKqlXU7PskEJ/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o4Jve5yERDOn8Ip7x14EORAnbQ",
#                                 "status" => "completed",
#                                 "recording_type" => "audio_only" }, {
#                                 "id" => "d49ef40a-46df-4b52-99a9-b2e74f9e3484",
#                                 "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                                 "recording_start" => "2021-02-01T16:18:47Z",
#                                 "recording_end" => "2021-02-01T16:20:16Z",
#                                 "file_type" => "MP4",
#                                 "file_extension" => "MP4",
#                                 "file_size" => 1670466,
#                                 "play_url" => "https://us02web.zoom.us/rec/play/MbtVkvFGf9YxIKdX9UeY5IiBGtO84K01xpduNBSpHUtGbHruFxTVHQy5qITQgxU0HaSSarHKo9uSj6ag.rTzusi_JTGKVBMiX",
#                                 "download_url" => "https://us02web.zoom.us/rec/webhook_download/MbtVkvFGf9YxIKdX9UeY5IiBGtO84K01xpduNBSpHUtGbHruFxTVHQy5qITQgxU0HaSSarHKo9uSj6ag.rTzusi_JTGKVBMiX/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o5tyDF52jUJIn7WgWL6wXrVmPM",
#                                 "status" => "completed",
#                                 "recording_type" => "shared_screen_with_speaker_view" }, {
#                                 "id" => "f8918192-09de-4fc8-ad4f-66e02fb3cec7",
#                                 "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                                 "recording_start" => "2021-02-01T16:18:47Z",
#                                 "recording_end" => "2021-02-01T16:20:16Z",
#                                 "file_type" => "M4A",
#                                 "file_extension" => "M4A",
#                                 "file_size" => 1412455,
#                                 "play_url" => "https://us02web.zoom.us/rec/play/Zt_wyyxmwI027AXKEDw5gwF2bKq2H3nWNOvVHvUHz2CrJYBhYMc2ZzGXcrLCfJNlxiPABSC6DX6nxSda.-KhpRxdF-ojlOd-c",
#                                 "download_url" => "https://us02web.zoom.us/rec/webhook_download/Zt_wyyxmwI027AXKEDw5gwF2bKq2H3nWNOvVHvUHz2CrJYBhYMc2ZzGXcrLCfJNlxiPABSC6DX6nxSda.-KhpRxdF-ojlOd-c/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o4Jve5yERDOn8Ip7x14EORAnbQ",
#                                 "status" => "completed",
#                                 "recording_type" => "audio_only" }, {
#                                 "id" => "ef828f08-4689-436c-a05d-45d54e7b3a52",
#                                 "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                                 "recording_start" => "2021-02-01T16:22:25Z",
#                                 "recording_end" => "2021-02-01T16:23:57Z",
#                                 "file_type" => "MP4",
#                                 "file_extension" => "MP4",
#                                 "file_size" => 1218474,
#                                 "play_url" => "https://us02web.zoom.us/rec/play/Z_JCv34Nh-yQUWWb67_cFiqENbTeSrErD8cpG5OAnm1CLO3K5XZYZ09FZC2Lo871v7qUPrgq-pAzrebt.QH3Vjprau3v7Ra0L",
#                                 "download_url" => "https://us02web.zoom.us/rec/webhook_download/Z_JCv34Nh-yQUWWb67_cFiqENbTeSrErD8cpG5OAnm1CLO3K5XZYZ09FZC2Lo871v7qUPrgq-pAzrebt.QH3Vjprau3v7Ra0L/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o5tyDF52jUJIn7WgWL6wXrVmPM",
#                                 "status" => "completed",
#                                 "recording_type" => "shared_screen_with_speaker_view" }, {
#                                 "id" => "c1fee964-195c-42f2-ab05-aeaf3a92ee5f",
#                                 "meeting_id" => "EnHa3FlBSWCo5yOup69pOw==",
#                                 "recording_start" => "2021-02-01T16:22:25Z",
#                                 "recording_end" => "2021-02-01T16:23:57Z",
#                                 "file_type" => "M4A",
#                                 "file_extension" => "M4A",
#                                 "file_size" => 1044710,
#                                 "play_url" => "https://us02web.zoom.us/rec/play/p5zBc5ck2qh0DzbUlcSgx7RPYMtEfac7RjKtz9M0lQ73Hl4tsCRurUJnUvESfsQYM8I3TX53fezj6NOu.ldpbXv9VIUcJqaJ5",
#                                 "download_url" => "https://us02web.zoom.us/rec/webhook_download/p5zBc5ck2qh0DzbUlcSgx7RPYMtEfac7RjKtz9M0lQ73Hl4tsCRurUJnUvESfsQYM8I3TX53fezj6NOu.ldpbXv9VIUcJqaJ5/98tyKvXX8EMtYozSy3jneY0ZFbTPdNbemilv5o4Jve5yERDOn8Ip7x14EORAnbQ",
#                                 "status" => "completed",
#                                 "recording_type" => "audio_only" }],
#         "password" => "%0Nye8^#" } },
#     "event_ts" => 1612197156252,
#     "event" => "recording.completed",
#     "download_token" => "eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJodHRwczovL2V2ZW50Lnpvb20udXMiLCJhY2NvdW50SWQiOiJ6STh0ak14blRIbVNqMHZMTVExX3dBIiwiYXVkIjoiaHR0cHM6Ly9vYXV0aC56b29tLnVzIiwibWlkIjoiRW5IYTNGbEJTV0NvNXlPdXA2OXBPdz09IiwiZXhwIjoxNjEyMjgzODIwLCJ1c2VySWQiOiJPZFQ5Rm1WUlNnNmVwbnpESFVtMnZ3In0.z__ZLHhMp_Rav3zGcubWK94z_lJx44jgOT1hQ3xpl30BVlprMSKo4f1HayLRWa2hY3uxaYyn9Zbm5Y1RnrPQow" } }

class Zoom::Webhook::Events::RecordingCompleted < Zoom::Webhook::Base
  @event_type = 'recording.completed'

  def perform
    puts @event

    meeting = ZoomMeeting.find_by(meeting_id: @event['payload']['object']['uuid'])
    if meeting
      session = meeting.session
      room = session.room
      @event['payload']['object']['recording_files'].select { |r| r['file_type'] == 'MP4' }.each do |recording|
        video = Video.find_or_initialize_by(zoom_id: recording['id'])
        if video.new_record?
          video.zoom_download_url = "#{recording['download_url']}?access_token=#{@event['download_token']}"
          video.zoom_state = recording['status']
          video.zoom_start_at = recording['recording_start']
          video.zoom_end_at = recording['recording_end']
          video.original_size = recording['file_size']
          video.duration = (video.zoom_end_at - video.zoom_start_at) * 1000
        end
        video.room_id = room.id
        video.user_id = session.presenter.user_id
        video.status = Video::Statuses::FOUND
        video.save
      end
    end
  end
end
